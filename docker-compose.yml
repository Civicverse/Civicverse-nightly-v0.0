version: "3.9"

services:
  # Blockchain & Mining
  monerod:
    build: ./monerod-stub
    container_name: civicverse-monerod
    ports:
      - "18081:18081"
      - "18083:18083"
    restart: unless-stopped
    networks:
      - civicverse

  kaspa-node:
    build: ./kaspa-stub
    container_name: civicverse-kaspa-node
    ports:
      - "16110:16110"
    restart: unless-stopped
    networks:
      - civicverse

  # Database
  postgres:
    image: postgres:15-alpine
    container_name: civicverse-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: civicverse
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - civicverse

  # Backend Services
  civicverse-backend:
    build: ./backend
    container_name: civicverse-backend
    env_file: .env
    depends_on:
      - monerod
      - postgres
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/civicverse
    restart: unless-stopped
    networks:
      - civicverse

  multiplayer-server:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: civicverse-multiplayer-server
    working_dir: /app
    command: node multiplayer-server.js
    ports:
      - "8080:8080"
    environment:
      - MULTIPLAYER_PORT=8080
      - NODE_ENV=production
    restart: unless-stopped
    networks:
      - civicverse

  # Ledger Service
  ledger:
    build: ./services/ledger
    container_name: civicverse-ledger
    environment:
      - POSTGRES_URL=postgres://postgres:postgres@postgres:5432/civicverse
      - NODE_ENV=production
    ports:
      - "4000:4000"
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - civicverse

  # Wallet Router
  wallet-router:
    build: ./services/wallet-router
    container_name: civicverse-wallet-router
    ports:
      - "5000:5000"
    restart: unless-stopped
    networks:
      - civicverse

  # API Gateway
  gateway:
    build: ./services/gateway
    container_name: civicverse-gateway
    environment:
      - LEDGER_URL=http://ledger:4000
      - WALLET_URL=http://wallet-router:5000
      - BACKEND_URL=http://civicverse-backend:3001
    ports:
      - "4001:4001"
    depends_on:
      - ledger
      - wallet-router
      - civicverse-backend
    restart: unless-stopped
    networks:
      - civicverse

  # CRAIG AI Watcher (Optional - disabled for now)
  # craig-watcher:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.craig
  #   container_name: civicverse-craig-watcher
  #   env_file: .env
  #   depends_on:
  #     - civicverse-backend
  #     - gateway
  #   restart: unless-stopped
  #   networks:
  #     - civicverse

  # Frontend (The Metaverse UI)
  civicverse-frontend:
    build: ./frontend
    container_name: civicverse-frontend
    env_file: .env
    ports:
      - "3000:80"
    depends_on:
      - civicverse-backend
      - multiplayer-server
      - gateway
    environment:
      - VITE_API_URL=http://civicverse-backend:3001
      - VITE_GATEWAY_URL=http://civicverse-gateway:4001
      - VITE_WS_URL=ws://localhost:8080
      - VITE_WALLET_URL=http://civicverse-wallet-router:5000
    restart: unless-stopped
    networks:
      - civicverse

networks:
  civicverse:
    driver: bridge

volumes:
  postgres-data:
  kaspa-data:

